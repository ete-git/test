<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>シフト休暇希望フォーム</title>

<!-- ====== 見た目（CSS）設定 ====== -->
<style>
  body{
    font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP";
    padding:18px; max-width:900px; margin:0 auto;
  }
  h1{font-size:20px;margin-bottom:6px;}
  .wrap{
    display:grid;
    grid-template-columns: 1fr 380px;
    gap:18px;
  }
  .calendar{
    background:#fff;
    border:1px solid #ddd;
    padding:12px;
    border-radius:8px;
  }
  .cal-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:8px;
  }
  button{cursor:pointer}
  .grid{
    display:grid;
    grid-template-columns:repeat(7,1fr);
    gap:6px;
  }
  .day{
    padding:8px;
    border-radius:6px;
    text-align:center;
    user-select:none;
  }
  .day:hover{background:#f0f0f0}
  .day.inactive{color:#bbb}
  .day.selected{background:#2d8cff;color:white}
  label{display:block;font-size:13px;margin-top:8px;}
  input, textarea{
    width:100%;
    box-sizing:border-box;
    padding:8px;
    margin-top:4px;
    border-radius:6px;
    border:1px solid #ccc
  }
  .submit{
    margin-top:12px;
    padding:10px 14px;
    border-radius:8px;
    background:#2d8cff;
    color:white;
    border:0;
    font-weight:600
  }
  .info{font-size:13px;color:#666;margin-top:8px}
</style>
</head>

<body>
  <h1>休暇希望フォーム</h1>

  <div class="wrap">
    <!-- ================= 左：カレンダー部分 ================= -->
    <div class="calendar">
      <div class="cal-header">
        <div>
          <button id="prev">&lt;</button>
          <button id="next">&gt;</button>
        </div>
        <div id="monthLabel"></div>
        <div></div>
      </div>

      <div class="grid" id="weekdayLabels" style="margin-bottom:6px;">
        <div>日</div><div>月</div><div>火</div><div>水</div><div>木</div><div>金</div><div>土</div>
      </div>

      <div class="grid" id="daysGrid"></div>

      <div class="info" id="calendarInfo">日付をクリックして選択してください。</div>
    </div>

    <!-- ================= 右：入力フォーム部分 ================= -->
    <div>
      <div style="background:#fff;border:1px solid #ddd;padding:12px;border-radius:8px;">
        <label>選択日
          <input id="selectedDate" type="text" readonly />
        </label>

        <label>名前
          <input id="name" type="text" placeholder="名前を入力" />
        </label>

        <label>開始時間
          <input id="startTime" type="time" />
        </label>

        <label>終了時間
          <input id="endTime" type="time" />
        </label>

        <label>備考（任意）
          <textarea id="notes" rows="3" placeholder=""></textarea>
        </label>

        <button class="submit" id="submitBtn">送信</button>
        <div id="result" class="info"></div>
      </div>
    </div>
  </div>

<!-- ================= スクリプト部分 ================= -->
<script>

// --- カレンダー ---
const daysGrid = document.getElementById('daysGrid');
const monthLabel = document.getElementById('monthLabel');
const prevBtn = document.getElementById('prev');
const nextBtn = document.getElementById('next');
let currentDate = new Date();
let selected = null;

function renderCalendar(date){
  daysGrid.innerHTML = '';
  const y = date.getFullYear();
  const m = date.getMonth();
  monthLabel.textContent = y + '年 ' + (m + 1) + '月';
  const first = new Date(y, m, 1);
  const last = new Date(y, m + 1, 0);
  const startPad = first.getDay();
  const total = last.getDate();

  // 前月の空白セル（見た目用）
  for(let i=0; i<startPad; i++){
    const d = document.createElement('div');
    d.className = 'day inactive';
    daysGrid.appendChild(d);
  }

  // 当月の日付セル
  for(let day=1; day<=total; day++){
    const d = document.createElement('div');
    d.className = 'day';
    d.textContent = day;
    const dateStr = formatDateYYYYMMDD(new Date(y,m,day)); // YYYY-MM-DD
    d.dataset.date = dateStr;
    if(selected === dateStr){
      d.classList.add('selected');
    }
    d.addEventListener('click', () => {
      selected = dateStr;
      document.querySelectorAll('.day').forEach(el => el.classList.remove('selected'));
      d.classList.add('selected');
      document.getElementById('selectedDate').value = dateStr;
      document.getElementById('calendarInfo').textContent = dateStr + ' を選択しました。';
    });
    daysGrid.appendChild(d);
  }
}

function formatDateYYYYMMDD(d){
  const Y = d.getFullYear();
  const M = String(d.getMonth()+1).padStart(2,'0');
  const D = String(d.getDate()).padStart(2,'0');
  return `${Y}-${M}-${D}`;
}

prevBtn.addEventListener('click', ()=>{
  currentDate.setMonth(currentDate.getMonth()-1);
  renderCalendar(currentDate);
});
nextBtn.addEventListener('click', ()=>{
  currentDate.setMonth(currentDate.getMonth()+1);
  renderCalendar(currentDate);
});
renderCalendar(currentDate);

// --- ユーティリティ関数 ---
// ローカル(ブラウザ)の現在日時を ISO 形式で得る（UTCではなくクライアントのタイムゾーン表現）
// ここではタイムスタンプとして ISO (UTC) を送る（GAS 側で解釈可能）。
function getSendDatetimeISO(){
  return new Date().toISOString(); // ex: 2025-10-20T00:12:34.567Z
}

// 時刻（HH:MM）から分数（小数時間）に変換。空文字は null を返す。
function calcDurationHours(startHHMM, endHHMM){
  if(!startHHMM || !endHHMM) return null;
  const [sh, sm] = startHHMM.split(':').map(Number);
  const [eh, em] = endHHMM.split(':').map(Number);
  // 日跨ぎを考慮して、終了が開始より前なら翌日扱い
  let startMins = sh*60 + sm;
  let endMins = eh*60 + em;
  if(endMins < startMins) endMins += 24*60;
  const diffM = endMins - startMins;
  return Math.round((diffM/60) * 100) / 100; // 小数2桁の時間（例: 1.50）
}

// --- フォーム送信処理 ---
// GASのURL
const GAS_URL = 'https://script.google.com/macros/s/AKfycbzL7SeC_6ttiq8bGmRSrkWUvEIIFK3N11wbw-mqZJ_BCU0pHOka7ByExZ8-FVE9nfO1Mw/exec'; // デプロイ後に置き換える

document.getElementById('submitBtn').addEventListener('click', async ()=>{
  const date = document.getElementById('selectedDate').value;
  const name = document.getElementById('name').value.trim();
  const start = document.getElementById('startTime').value;
  const end = document.getElementById('endTime').value;
  const notes = document.getElementById('notes').value.trim();
  const result = document.getElementById('result');
  result.textContent = '';

  // --- バリデーション ---
  if(!date){ result.textContent = '日付を選択してください。'; return; }
  if(!name){ result.textContent = '名前を入力してください。'; return; }
  // 時間がどちらも空なら可、片方だけだとエラー
  if((start && !end) || (!start && end)){
    result.textContent = '開始時間と終了時間は両方入力するか、両方未入力にしてください。';
    return;
  }

  // duration を計算（両方入力時のみ）
  const duration = calcDurationHours(start, end); // null または 小数（h）
  const payload = {
    sendDatetime: getSendDatetimeISO(), // 送信日時（ISO）
    name,
    date,        // 希望日（YYYY-MM-DD）
    startTime: start || '', // 空文字許容
    endTime: end || '',
    durationHours: duration === null ? '' : String(duration), // スプレッドシート保存用に文字列化
    notes
  };

  // ボタン無効化して多重送信を防ぐ
  const submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = true;
  submitBtn.textContent = '送信中...';

  try {
    // POST で JSON を送信
    const params = new URLSearchParams({
      sendDatetime: getSendDatetimeISO(),
      name,
      date,
      startTime: start || '',
      endTime: end || '',
      durationHours: duration === null ? '' : String(duration),
      notes
    });

    const res = await fetch(GAS_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: params
    });

    if (!res.ok) {
      // サーバーが200系以外を返した場合はテキストを表示
      const text = await res.text();
      alert('サーバーエラー: ' + text);
      result.textContent = 'サーバーエラー: ' + text;
      return;
    }

    // レスポンスは JSON を期待（GAS で JSON を返す）
    const json = await res.json();

    if (json.status === 'ok') {
      alert('送信完了しました');
      result.textContent = '送信完了しました（' + payload.sendDatetime + '）';
      // 送信後はフォームをクリア（選択はそのまま）
      document.getElementById('name').value = '';
      document.getElementById('startTime').value = '';
      document.getElementById('endTime').value = '';
      document.getElementById('notes').value = '';
      // optional: calendar の選択解除をしたい場合は以下の2行のコメントを外す
      // selected = null;
      // document.querySelectorAll('.day').forEach(el => el.classList.remove('selected'));

    } else {
      alert('送信エラー: ' + (json.message || '不明なエラー'));
      result.textContent = '送信エラー: ' + (json.message || '不明なエラー');
    }

  } catch (err) {
    // ネットワークエラー等
    alert('通信中にエラーが発生しました: ' + err.message);
    result.textContent = '通信中にエラーが発生しました: ' + err.message;
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = '送信';
  }
});
</script>
</body>
</html>
